"""utilities"""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/04_utils.ipynb.

# %% auto #0
__all__ = ['save_checkpoint']

# %% ../nbs/04_utils.ipynb #b96051a7
import os 
import torch

# %% ../nbs/04_utils.ipynb #a164c279
def save_checkpoint(model, optimizer, epoch, val_loss, cfg, save_every=10, n_keep=5, verbose=True, tag=""):
    "Saves new checkpoint, keeps best & the most recent n_keep"
    if not hasattr(save_checkpoint, 'best_val_loss'):
        save_checkpoint.best_val_loss = float('inf')

    os.makedirs('checkpoints', exist_ok=True)
    ckpt = {'epoch': epoch, 'model_state_dict': model.state_dict(),
            'optimizer_state_dict': optimizer.state_dict(), 'config': dict(cfg), 'val_loss': val_loss}

    if epoch % save_every == 0:
        if verbose: print(f"Saving checkpoint to checkpoints/{tag}ckpt_epoch{epoch}.pt")
        torch.save(ckpt, f'checkpoints/{tag}ckpt_epoch{epoch}.pt')
    if val_loss < save_checkpoint.best_val_loss:
        torch.save(ckpt, f'checkpoints/{tag}best.pt')
        save_checkpoint.best_val_loss = val_loss

    ckpts = sorted([f for f in os.listdir('checkpoints') if f.startswith(f'{tag}ckpt_epoch')],
                   key=lambda x: int(x.split('epoch')[1].split('.')[0]))
    for old in ckpts[:-n_keep]: os.remove(f'checkpoints/{old}')
