<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Swin Transformer V2 Encoder for midi-rae — drop-in replacement for ViTEncoder">

<title>swin – midi-rae</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-baedc78cbf92349237790bf011c153e8.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="swin – midi-rae">
<meta property="og:description" content="Swin Transformer V2 Encoder for midi-rae — drop-in replacement for ViTEncoder">
<meta property="og:image" content="https://drscotthawley.github.io/midi-rae/10_swin_files/figure-html/cell-4-output-2.png">
<meta property="og:site_name" content="midi-rae">
<meta property="og:image:height" content="259">
<meta property="og:image:width" content="1590">
<meta name="twitter:title" content="swin – midi-rae">
<meta name="twitter:description" content="Swin Transformer V2 Encoder for midi-rae — drop-in replacement for ViTEncoder">
<meta name="twitter:image" content="https://drscotthawley.github.io/midi-rae/10_swin_files/figure-html/cell-4-output-2.png">
<meta name="twitter:image-height" content="259">
<meta name="twitter:image-width" content="1590">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">midi-rae</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./swin.html">swin</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">midi-rae</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">core</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./vit.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ViT</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./losses.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">losses</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">utils</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./viz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">viz</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./train_enc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">train_enc</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./inspect.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Inspect</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preencode.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pre-encode</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./train_dec.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Train Decoder</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./swin.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">swin</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./toy_factorization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Toy “Soft” Factorization Experiment</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#design-overview" id="toc-design-overview" class="nav-link active" data-scroll-target="#design-overview">Design Overview</a>
  <ul class="collapse">
  <li><a href="#motivation-multi-scale-understanding" id="toc-motivation-multi-scale-understanding" class="nav-link" data-scroll-target="#motivation-multi-scale-understanding">Motivation: Multi-Scale Understanding</a></li>
  <li><a href="#same-info-organized-differently" id="toc-same-info-organized-differently" class="nav-link" data-scroll-target="#same-info-organized-differently">Same Info, Organized Differently</a></li>
  <li><a href="#what-this-module-does" id="toc-what-this-module-does" class="nav-link" data-scroll-target="#what-this-module-does">What this module does</a></li>
  <li><a href="#why-swin-v2" id="toc-why-swin-v2" class="nav-link" data-scroll-target="#why-swin-v2">Why Swin V2?</a></li>
  <li><a href="#architecture" id="toc-architecture" class="nav-link" data-scroll-target="#architecture">Architecture</a></li>
  <li><a href="#implementation-approach" id="toc-implementation-approach" class="nav-link" data-scroll-target="#implementation-approach">Implementation approach</a></li>
  <li><a href="#key-differences-from-vitencoder" id="toc-key-differences-from-vitencoder" class="nav-link" data-scroll-target="#key-differences-from-vitencoder">Key differences from ViTEncoder</a></li>
  <li><a href="#todos" id="toc-todos" class="nav-link" data-scroll-target="#todos">TODOs</a></li>
  <li><a href="#future-advanced-masking-representation-learning" id="toc-future-advanced-masking-representation-learning" class="nav-link" data-scroll-target="#future-advanced-masking-representation-learning">Future: advanced masking &amp; representation learning</a></li>
  <li><a href="#swinencoder" id="toc-swinencoder" class="nav-link" data-scroll-target="#swinencoder">SwinEncoder</a></li>
  <li><a href="#pixelshufflehead" id="toc-pixelshufflehead" class="nav-link" data-scroll-target="#pixelshufflehead">PixelShuffleHead</a></li>
  <li><a href="#swinmaedecoder" id="toc-swinmaedecoder" class="nav-link" data-scroll-target="#swinmaedecoder">SwinMAEDecoder</a></li>
  <li><a href="#swindecoder" id="toc-swindecoder" class="nav-link" data-scroll-target="#swindecoder">SwinDecoder</a></li>
  <li><a href="#patchexpand" id="toc-patchexpand" class="nav-link" data-scroll-target="#patchexpand">PatchExpand</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/drscotthawley/midi-rae/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="swin.html.md"><i class="bi bi-file-code"></i>CommonMark</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">swin</h1>
</div>

<div>
  <div class="description">
    Swin Transformer V2 Encoder for midi-rae — drop-in replacement for ViTEncoder
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="design-overview" class="level2">
<h2 class="anchored" data-anchor-id="design-overview">Design Overview</h2>
<section id="motivation-multi-scale-understanding" class="level3">
<h3 class="anchored" data-anchor-id="motivation-multi-scale-understanding">Motivation: Multi-Scale Understanding</h3>
<p>We’re not doing mere image segmentation. The representations at different scales may be very different from one another and mapped non-linearly. Consider: the top-level representation could be something about musical genre. The next level down could be something about what part of the song we’re in. The next level down could be which part of the verse or chorus we’re in. The next level could be a given musical phrase. The next level could be the individual notes in the phrase.</p>
</section>
<section id="same-info-organized-differently" class="level3">
<h3 class="anchored" data-anchor-id="same-info-organized-differently">Same Info, Organized Differently</h3>
<p><strong>ViT:</strong> The default ViT we’ve been using has 65 patches with 256 dimensions each: 65 * 256 = <strong>16,640 encoding parameters</strong>.</p>
<p>For the a Swin with 6 stages, <code>embed_dim=8</code>, <code>patch_h=patch_w=4</code>, so the finest grid is 32×32:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Level</th>
<th>Patch Size (px)</th>
<th>Grid</th>
<th>Dim</th>
<th>Scalars</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0 (coarsest)</td>
<td>128x128</td>
<td>1×1</td>
<td>256</td>
<td>256</td>
</tr>
<tr class="even">
<td>1</td>
<td>64x64</td>
<td>2×2</td>
<td>128</td>
<td>512</td>
</tr>
<tr class="odd">
<td>2</td>
<td>32x32</td>
<td>4×4</td>
<td>64</td>
<td>1,024</td>
</tr>
<tr class="even">
<td>3</td>
<td>16x16</td>
<td>8×8</td>
<td>32</td>
<td>2,048</td>
</tr>
<tr class="odd">
<td>4</td>
<td>8x8</td>
<td>16×16</td>
<td>16</td>
<td>4,096</td>
</tr>
<tr class="even">
<td>5 (finest)</td>
<td>4x4</td>
<td>32x32</td>
<td>8</td>
<td>8,192</td>
</tr>
<tr class="odd">
<td><strong>Total</strong></td>
<td></td>
<td></td>
<td><strong>16,128 encoding parameters</strong></td>
<td></td>
</tr>
</tbody>
</table>
<p>…So the Swin has basically the same amount of information as the ViT (actually slightly less!), it’s just organized differently.</p>
</section>
<section id="what-this-module-does" class="level3">
<h3 class="anchored" data-anchor-id="what-this-module-does">What this module does</h3>
<p><code>SwinEncoder</code> is a drop-in replacement for <code>ViTEncoder</code> that uses the <strong>Swin Transformer V2</strong> architecture. It takes a piano roll image <code>(B, 1, 128, 128)</code> and returns an <code>EncoderOutput</code> with hierarchical multi-scale patch states.</p>
</section>
<section id="why-swin-v2" class="level3">
<h3 class="anchored" data-anchor-id="why-swin-v2">Why Swin V2?</h3>
<ul>
<li><strong>Hierarchical representation</strong>: 7 levels from finest (64×64 grid, dim=4) down to a single CLS-like token (1×1, dim=256), compared to ViT’s flat single-scale output</li>
<li><strong>Efficient attention</strong>: Windowed attention with shifted windows — O(N) instead of O(N²)</li>
<li><strong>V2 improvements</strong>: Cosine attention with learned log-scale temperature, continuous position bias via CPB MLP, res-post-norm for training stability</li>
</ul>
</section>
<section id="architecture" class="level3">
<h3 class="anchored" data-anchor-id="architecture">Architecture</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Stage</th>
<th>Grid</th>
<th>Patch covers</th>
<th>Dim</th>
<th>Depths</th>
<th>Heads</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>64×64</td>
<td>2×2</td>
<td>4</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td>1</td>
<td>32×32</td>
<td>4×4</td>
<td>8</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td>2</td>
<td>16×16</td>
<td>8×8</td>
<td>16</td>
<td>2</td>
<td>1</td>
</tr>
<tr class="even">
<td>3</td>
<td>8×8</td>
<td>16×16</td>
<td>32</td>
<td>2</td>
<td>2</td>
</tr>
<tr class="odd">
<td>4</td>
<td>4×4</td>
<td>32×32</td>
<td>64</td>
<td>6</td>
<td>4</td>
</tr>
<tr class="even">
<td>5</td>
<td>2×2</td>
<td>64×64</td>
<td>128</td>
<td>2</td>
<td>8</td>
</tr>
<tr class="odd">
<td>6</td>
<td>1×1</td>
<td>128×128</td>
<td>256</td>
<td>1</td>
<td>16</td>
</tr>
</tbody>
</table>
<p>Config is in <code>configs/config_swin.yaml</code>.</p>
</section>
<section id="implementation-approach" class="level3">
<h3 class="anchored" data-anchor-id="implementation-approach">Implementation approach</h3>
<p>We use <strong>timm’s <code>SwinTransformerV2Stage</code> directly</strong> — no copied or modified Swin internals. Our <code>SwinEncoder</code> wrapper handles only:</p>
<ol type="1">
<li><strong>Patch embedding</strong> — <code>Conv2d(1, 4, kernel_size=2, stride=2)</code> + LayerNorm</li>
<li><strong>Empty patch detection</strong> — patches where all pixels are black get a learnable <code>empty_token</code></li>
<li><strong>MAE masking</strong> (SimMIM-style) — masked patches get a learnable <code>mask_token</code>, grid stays intact so windowed attention works unmodified. Two-rate sampling: non-empty patches masked at <code>mask_ratio</code>, empty patches at <code>mask_ratio × empty_mask_ratio</code> (default 5%)</li>
<li><strong>Hierarchical output</strong> — collects each stage’s output into <code>HierarchicalPatchState</code> (coarsest-first), packaged as <code>EncoderOutput</code></li>
</ol>
</section>
<section id="key-differences-from-vitencoder" class="level3">
<h3 class="anchored" data-anchor-id="key-differences-from-vitencoder">Key differences from ViTEncoder</h3>
<ul>
<li>No CLS token (stage 6’s single 1×1 token serves as a global summary)</li>
<li>No RoPE (Swin V2 uses its own continuous position bias)</li>
<li>MAE masking keeps all tokens (SimMIM-style) — no compute savings but preserves spatial grid</li>
<li><code>empty_mask_ratio</code> controls how often trivial-to-reconstruct empty patches are masked</li>
</ul>
</section>
<section id="todos" class="level3">
<h3 class="anchored" data-anchor-id="todos">TODOs</h3>
<ul>
<li><code>HierarchicalPatchState</code> could store <code>window_size</code> per level</li>
<li><code>EncoderOutput</code> could store scale metadata (downsample factors per level)</li>
</ul>
</section>
<section id="future-advanced-masking-representation-learning" class="level3">
<h3 class="anchored" data-anchor-id="future-advanced-masking-representation-learning">Future: advanced masking &amp; representation learning</h3>
<ul>
<li><strong>Inter-stage patch masking</strong>: dropout-style masking between encoder stages, tapered ratio per stage (<code>mae_ratio / 2**stage_idx</code>), using a learnable mask token. Forces robust representations at every scale.</li>
<li><strong>Self-distillation</strong> (DINO/iBOT-style): EMA teacher provides latent targets at all scales, eliminating need for pixel-level reconstruction at coarser levels.</li>
<li><strong>Multi-scale reconstruction losses</strong>: reconstruct downsampled piano rolls at each hierarchy level (requires bidirectional decoder, e.g.&nbsp;U-Net with skip connections).</li>
</ul>
<hr>
</section>
<section id="swinencoder" class="level3">
<h3 class="anchored" data-anchor-id="swinencoder">SwinEncoder</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> SwinEncoder(</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    img_height:<span class="bu">int</span>, <span class="co"># Input image height in pixels (e.g. 128)</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    img_width:<span class="bu">int</span>, <span class="co"># Input image width in pixels (e.g. 128)</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    patch_h:<span class="bu">int</span><span class="op">=</span><span class="dv">4</span>, <span class="co"># Patch height for initial embedding</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    patch_w:<span class="bu">int</span><span class="op">=</span><span class="dv">4</span>, <span class="co"># Patch width for initial embedding</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    in_chans:<span class="bu">int</span><span class="op">=</span><span class="dv">1</span>, <span class="co"># Number of input channels (1 for piano roll)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    embed_dim:<span class="bu">int</span><span class="op">=</span><span class="dv">8</span>, <span class="co"># Base embedding dimension (doubles each stage)</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    depths:<span class="bu">tuple</span><span class="op">=</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">6</span>, <span class="dv">2</span>, <span class="dv">1</span>), <span class="co"># Number of transformer blocks per stage</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    num_heads:<span class="bu">tuple</span><span class="op">=</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>, <span class="dv">16</span>), <span class="co"># Attention heads per stage</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    window_size:<span class="bu">int</span><span class="op">=</span><span class="dv">8</span>, <span class="co"># Window size for windowed attention</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    mlp_ratio:<span class="bu">float</span><span class="op">=</span><span class="fl">4.0</span>, <span class="co"># MLP hidden dim = embed_dim * mlp_ratio</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    qkv_bias:<span class="bu">bool</span><span class="op">=</span><span class="va">True</span>, <span class="co"># Add bias to QKV projections</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    drop_rate:<span class="bu">float</span><span class="op">=</span><span class="fl">0.0</span>, <span class="co"># Dropout after patch embedding</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    proj_drop_rate:<span class="bu">float</span><span class="op">=</span><span class="fl">0.0</span>, <span class="co"># Dropout after attention projection</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    attn_drop_rate:<span class="bu">float</span><span class="op">=</span><span class="fl">0.0</span>, <span class="co"># Dropout on attention weights</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    drop_path_rate:<span class="bu">float</span><span class="op">=</span><span class="fl">0.1</span>, <span class="co"># Stochastic depth rate</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    norm_layer:<span class="bu">type</span><span class="op">=</span>LayerNorm, <span class="co"># Normalization layer class</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    mae_ratio:<span class="bu">float</span><span class="op">=</span><span class="fl">0.0</span>, <span class="co"># Fraction of non-empty patches to mask (0=no masking)</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    empty_mask_ratio:<span class="bu">float</span><span class="op">=</span><span class="fl">0.05</span>, <span class="co"># Mask rate for empty patches relative to mae_ratio</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Swin Transformer V2 Encoder for midi-rae — drop-in replacement for ViTEncoder. (Wrapper for timm routines)</em></p>
<div id="f5babacc" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test: verify SwinEncoder output shapes</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>B, C, H, W <span class="op">=</span> <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">128</span>, <span class="dv">128</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>enc <span class="op">=</span> SwinEncoder(img_height<span class="op">=</span>H, img_width<span class="op">=</span>W)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> torch.randn(B, C, H, W)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> enc(x)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'mae_mask:        </span><span class="sc">{</span>out<span class="sc">.</span>mae_mask<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'full_pos:        </span><span class="sc">{</span>out<span class="sc">.</span>full_pos<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'full_non_empty:  </span><span class="sc">{</span>out<span class="sc">.</span>full_non_empty<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'num levels:      </span><span class="sc">{</span><span class="bu">len</span>(out.patches.levels)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ps <span class="kw">in</span> <span class="bu">enumerate</span>(out.patches.levels):</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> <span class="bu">int</span>(ps.pos.shape[<span class="dv">0</span>]<span class="op">**</span><span class="fl">0.5</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> H <span class="op">//</span> g</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'  level </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: emb=</span><span class="sc">{</span>ps<span class="sc">.</span>emb<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">, pos=</span><span class="sc">{</span>ps<span class="sc">.</span>pos<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">  — grid </span><span class="sc">{</span>g<span class="sc">}</span><span class="ss">×</span><span class="sc">{</span>g<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>p<span class="sc">}</span><span class="ss">×</span><span class="sc">{</span>p<span class="sc">}</span><span class="ss"> patch</span><span class="sc">{</span><span class="st">"es"</span> <span class="cf">if</span> ps<span class="sc">.</span>emb<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="op">&gt;</span><span class="dv">1</span> <span class="cf">else</span> <span class="st">""</span><span class="sc">}</span><span class="ss">)'</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected hierarchy (coarsest first), 128×128 image, 2×2 patches:</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   level 0 (coarsest): emb=(1, 1,    256) — grid 1×1  (CLS-like)</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co">#   level 1:            emb=(1, 4,    128) — grid 2×2</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co">#   level 2:            emb=(1, 16,    64) — grid 4×4</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co">#   level 3:            emb=(1, 64,    32) — grid 8×8</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co">#   level 4:            emb=(1, 256,   16) — grid 16×16</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co">#   level 5:            emb=(1, 1024,   8) — grid 32×32</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co">#   level 6 (finest):   emb=(1, 4096,   4) — grid 64×64</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>mae_mask:        torch.Size([2, 4096])
full_pos:        torch.Size([4096, 2])
full_non_empty:  torch.Size([2, 4096])
num levels:      7
  level 0: emb=torch.Size([2, 1, 256]), pos=torch.Size([1, 2])  — grid 1×1 (128×128 patch)
  level 1: emb=torch.Size([2, 4, 128]), pos=torch.Size([4, 2])  — grid 2×2 (64×64 patches)
  level 2: emb=torch.Size([2, 16, 64]), pos=torch.Size([16, 2])  — grid 4×4 (32×32 patches)
  level 3: emb=torch.Size([2, 64, 32]), pos=torch.Size([64, 2])  — grid 8×8 (16×16 patches)
  level 4: emb=torch.Size([2, 256, 16]), pos=torch.Size([256, 2])  — grid 16×16 (8×8 patches)
  level 5: emb=torch.Size([2, 1024, 8]), pos=torch.Size([1024, 2])  — grid 32×32 (4×4 patches)
  level 6: emb=torch.Size([2, 4096, 4]), pos=torch.Size([4096, 2])  — grid 64×64 (2×2 patches)</code></pre>
</div>
</div>
<p>Testing code to check for non-empty patches: Green equals non-empty, red equals empty</p>
<div id="2db3059d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> midi_rae.data <span class="im">import</span> PRPairDataset</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load one image from the dataset</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> PRPairDataset(split<span class="op">=</span><span class="st">'val'</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>img_tensor <span class="op">=</span> ds[<span class="dv">0</span>][<span class="st">'img1'</span>][:<span class="dv">1</span>]</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> img_tensor.unsqueeze(<span class="dv">0</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Run empty patch detection</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>enc <span class="op">=</span> SwinEncoder(img_height<span class="op">=</span><span class="dv">128</span>, img_width<span class="op">=</span><span class="dv">128</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>non_empty <span class="op">=</span> enc._compute_non_empty(x)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>ne <span class="op">=</span> non_empty[<span class="dv">0</span>].reshape(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">64</span>, <span class="dv">64</span>).<span class="bu">float</span>()</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Build hierarchy via max-pool cascade</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>levels <span class="op">=</span> [ne[<span class="dv">0</span>, <span class="dv">0</span>].cpu()]  <span class="co"># 64×64</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> levels[<span class="op">-</span><span class="dv">1</span>].shape[<span class="dv">0</span>] <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    ne <span class="op">=</span> F.max_pool2d(ne, <span class="dv">2</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    levels.append(ne[<span class="dv">0</span>, <span class="dv">0</span>].cpu())</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot: original image + all levels</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="bu">len</span>(levels) <span class="op">+</span> <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="fl">2.7</span>))</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].imshow(img_tensor[<span class="dv">0</span>].cpu(), cmap<span class="op">=</span><span class="st">'gray'</span>, origin<span class="op">=</span><span class="st">'lower'</span>, aspect<span class="op">=</span><span class="st">'auto'</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Original</span><span class="ch">\n</span><span class="st">128×128 px'</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, grid <span class="kw">in</span> <span class="bu">enumerate</span>(levels):</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> grid.shape[<span class="dv">0</span>]</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    axes[i<span class="op">+</span><span class="dv">1</span>].imshow(grid.numpy(), cmap<span class="op">=</span><span class="st">'RdYlGn'</span>, origin<span class="op">=</span><span class="st">'lower'</span>, aspect<span class="op">=</span><span class="st">'auto'</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> <span class="dv">128</span> <span class="op">//</span> g</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    axes[i<span class="op">+</span><span class="dv">1</span>].set_title(<span class="ss">f'Level </span><span class="sc">{</span>i<span class="sc">}</span><span class="ch">\n</span><span class="sc">{</span>g<span class="sc">}</span><span class="ss">×</span><span class="sc">{</span>g<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>p<span class="sc">}</span><span class="ss">×</span><span class="sc">{</span>p<span class="sc">}</span><span class="ss">px)'</span>)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    axes[i<span class="op">+</span><span class="dv">1</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axis(<span class="st">'off'</span>)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loading 273 val files from ~/datasets/POP909_images/...
Finished loading.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="10_swin_files/figure-html/cell-4-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="pixelshufflehead" class="level3">
<h3 class="anchored" data-anchor-id="pixelshufflehead">PixelShuffleHead</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> PixelShuffleHead(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    out_channels:<span class="bu">int</span><span class="op">=</span><span class="dv">1</span>, fpn_dim:<span class="bu">int</span><span class="op">=</span><span class="dv">64</span>, hidden_ch:<span class="bu">int</span><span class="op">=</span><span class="dv">64</span>, patch_size:<span class="bu">int</span><span class="op">=</span><span class="dv">4</span>, grid_h:<span class="bu">int</span><span class="op">=</span><span class="dv">32</span>, grid_w:<span class="bu">int</span><span class="op">=</span><span class="dv">32</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Base class for all neural network modules.</em></p>
<p>Your models should also subclass this class.</p>
<p>Modules can also contain other Modules, allowing them to be nested in a tree structure. You can assign the submodules as regular attributes::</p>
<pre><code>import torch.nn as nn
import torch.nn.functional as F

class Model(nn.Module):
    def __init__(self) -&gt; None:
        super().__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))</code></pre>
<p>Submodules assigned in this way will be registered, and will also have their parameters converted when you call :meth:<code>to</code>, etc.</p>
<p>.. note:: As per the example above, an <code>__init__()</code> call to the parent class must be made before assignment on the child.</p>
<p>:ivar training: Boolean represents whether this module is in training or evaluation mode. :vartype training: bool</p>
<hr>
</section>
<section id="swinmaedecoder" class="level3">
<h3 class="anchored" data-anchor-id="swinmaedecoder">SwinMAEDecoder</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> SwinMAEDecoder(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    patch_size:<span class="bu">int</span><span class="op">=</span><span class="dv">4</span>, dims:<span class="bu">tuple</span><span class="op">=</span>(<span class="dv">256</span>, <span class="dv">128</span>, <span class="dv">64</span>, <span class="dv">32</span>, <span class="dv">16</span>, <span class="dv">8</span>), fpn_dim:<span class="bu">int</span><span class="op">=</span><span class="dv">64</span>, depth:<span class="bu">int</span><span class="op">=</span><span class="dv">2</span>, heads:<span class="bu">int</span><span class="op">=</span><span class="dv">4</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>FPN-style MAE decoder for SwinEncoder hierarchical output.</em> Top-down pathway fuses all levels, reconstructs at finest scale.</p>
<hr>
</section>
<section id="swindecoder" class="level3">
<h3 class="anchored" data-anchor-id="swindecoder">SwinDecoder</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> SwinDecoder(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    img_height:<span class="bu">int</span><span class="op">=</span><span class="dv">128</span>, <span class="co"># Output image height</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    img_width:<span class="bu">int</span><span class="op">=</span><span class="dv">128</span>, <span class="co"># Output image width</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    patch_h:<span class="bu">int</span><span class="op">=</span><span class="dv">4</span>, <span class="co"># Patch height (must match encoder)</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    patch_w:<span class="bu">int</span><span class="op">=</span><span class="dv">4</span>, <span class="co"># Patch width (must match encoder)</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    out_channels:<span class="bu">int</span><span class="op">=</span><span class="dv">1</span>, <span class="co"># Output channels (1 for piano roll)</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    embed_dim:<span class="bu">int</span><span class="op">=</span><span class="dv">8</span>, <span class="co"># Base embedding dim (same as encoder)</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    depths:<span class="bu">tuple</span><span class="op">=</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">6</span>, <span class="dv">2</span>, <span class="dv">1</span>), <span class="co"># Encoder depths (finest→coarsest); reversed internally</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    num_heads:<span class="bu">tuple</span><span class="op">=</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>, <span class="dv">16</span>), <span class="co"># Encoder heads (finest→coarsest); reversed internally</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    window_size:<span class="bu">int</span><span class="op">=</span><span class="dv">8</span>, <span class="co"># Window size for windowed attention</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    mlp_ratio:<span class="bu">float</span><span class="op">=</span><span class="fl">4.0</span>, <span class="co"># MLP hidden dim = dim * mlp_ratio</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    qkv_bias:<span class="bu">bool</span><span class="op">=</span><span class="va">True</span>, <span class="co"># Bias in QKV projections</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    drop_path_rate:<span class="bu">float</span><span class="op">=</span><span class="fl">0.1</span>, <span class="co"># Stochastic depth rate</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    proj_drop_rate:<span class="bu">float</span><span class="op">=</span><span class="fl">0.0</span>, <span class="co"># Dropout after attention projection</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    attn_drop_rate:<span class="bu">float</span><span class="op">=</span><span class="fl">0.0</span>, <span class="co"># Dropout on attention weights</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    norm_layer:<span class="bu">type</span><span class="op">=</span>LayerNorm</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Swin V2 Decoder for midi-rae — symmetric multi-stage decoder.</em></p>
<p>Mirrors the encoder architecture: processes coarsest→finest with Swin V2 windowed attention at every spatial scale, fusing encoder skip connections via lateral projections at each level.</p>
<p>Pass the same config values (embed_dim, depths, num_heads) as the encoder; they are reversed internally for the coarsest→finest decode direction.</p>
<p>Takes EncoderOutput directly (same interface as SwinMAEDecoder).</p>
<p>TODO: Try ConvTranspose2d or PixelShuffle as alternatives to linear unpatchify. TODO: Make the unpatchify head swappable via a factory or argument.</p>
<hr>
</section>
<section id="patchexpand" class="level3">
<h3 class="anchored" data-anchor-id="patchexpand">PatchExpand</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> PatchExpand(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    in_dim, out_dim, norm_layer:<span class="bu">type</span><span class="op">=</span>LayerNorm</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><em>Inverse of patch merging: doubles spatial resolution via learned linear expansion.</em> (B, H, W, C_in) → (B, 2H, 2W, C_out)</p>
<p>Test: verify SwinDecoder output shapes:</p>
<div id="335c29b1-56ff-48c6-b9e6-df1e63c69fdb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>B, C, H, W <span class="op">=</span> <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">128</span>, <span class="dv">128</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>depths, num_heads <span class="op">=</span> (<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">6</span>,<span class="dv">2</span>,<span class="dv">1</span>), (<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">8</span>,<span class="dv">16</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>enc <span class="op">=</span> SwinEncoder(img_height<span class="op">=</span>H, img_width<span class="op">=</span>W, patch_h<span class="op">=</span><span class="dv">4</span>, patch_w<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                  embed_dim<span class="op">=</span><span class="dv">8</span>, depths<span class="op">=</span>depths, num_heads<span class="op">=</span>num_heads)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>dec <span class="op">=</span> SwinDecoder(img_height<span class="op">=</span>H, img_width<span class="op">=</span>W, patch_h<span class="op">=</span><span class="dv">4</span>, patch_w<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                  embed_dim<span class="op">=</span><span class="dv">8</span>, depths<span class="op">=</span>depths, num_heads<span class="op">=</span>num_heads)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> torch.randn(B, C, H, W)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>enc_out <span class="op">=</span> enc(x)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>recon <span class="op">=</span> dec(enc_out)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Input:  </span><span class="sc">{</span>x<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Output: </span><span class="sc">{</span>recon<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> recon.shape <span class="op">==</span> x.shape, <span class="ss">f'Shape mismatch: </span><span class="sc">{</span>recon<span class="sc">.</span>shape<span class="sc">}</span><span class="ss"> != </span><span class="sc">{</span>x<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'✓ Shapes match!'</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>enc_params <span class="op">=</span> <span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> enc.parameters())</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>dec_params <span class="op">=</span> <span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> dec.parameters())</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Encoder params: </span><span class="sc">{</span>enc_params<span class="sc">:,}</span><span class="ss">'</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Decoder params: </span><span class="sc">{</span>dec_params<span class="sc">:,}</span><span class="ss">'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Input:  torch.Size([2, 1, 128, 128])
Output: torch.Size([2, 1, 128, 128])
✓ Shapes match!
Encoder params: 1,748,135
Decoder params: 1,035,735</code></pre>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/drscotthawley\.github\.io\/midi-rae");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/drscotthawley/midi-rae/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>